<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper 
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="REVIEW">
 
	<select id="SELECT_ONE_REVIEW" parameterType="com.eighty.review.ReviewVO" resultType="com.eighty.review.ReviewVO">
    SELECT * FROM review 
    WHERE order_code = #{order_code} 
      AND product_code = #{product_code}
	</select>
	
	<select id="SELECT_AVG_GRADE" parameterType="String" resultType="double">
	    SELECT COALESCE(ROUND(AVG(grade_point), 1), 0.0) 
	    FROM review 
	    WHERE product_code = #{product_code}
	</select>
	
	<select id="SELECT_REVIEW_COUNT" parameterType="String" resultType="int">
	    SELECT COUNT(*) 
	    FROM review
	    WHERE product_code = #{product_code}
	</select>

    <select id="SELECT_REVIEW_LIST" parameterType="com.eighty.review.ReviewVO" resultType="com.eighty.review.ReviewVO">
        SELECT * FROM review
        <where>
            <if test="product_code != null and product_code != ''">
                AND product_code = #{product_code}
            </if>
        </where>
        ORDER BY idx DESC
    </select>
    
    <insert id="insertReview" parameterType="com.eighty.review.ReviewVO">
	    INSERT INTO review (
	        user_id, order_code, product_code, grade_point, 
	        review_title, review_content, review_img, reg_date
	    ) VALUES (
	        #{user_id}, #{order_code}, #{product_code}, #{grade_point}, 
	        #{review_title}, #{review_content}, #{review_img}, NOW()
	    )
	    <selectKey keyProperty="idx" resultType="long" order="AFTER">
	        SELECT LAST_INSERT_ID()
	    </selectKey>
	</insert>
	
	<update id="UPDATE_REVIEW_STATUS" parameterType="com.eighty.review.ReviewVO">
	    UPDATE purchase 
	    SET isReview = 'y' 
	    WHERE orderCode = #{order_code} 
	      AND productCode = #{product_code}
	</update>
	
</mapper>