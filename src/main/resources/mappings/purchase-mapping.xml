<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper 
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="PURCHASE">
 
	<select id="getPurchaseList" resultType="com.eighty.purchase.PurchaseVO">
    	SELECT * FROM purchase
    	<where>
        	<if test="userId != null and userId != ''">
            	AND userId = #{userId}
        	</if>
        	<if test="orderCode != null and orderCode != ''">
            AND orderCode = #{orderCode}
        </if>
    	</where>
    	ORDER BY orderCode DESC
	</select>
	
	<select id="getPurchaseListOne" resultType="com.eighty.purchase.PurchaseVO">
    	SELECT * FROM purchase
    	where orderCode = #{orderCode}
	</select>
	
	<select id="getPurchaseListSummary" resultType="com.eighty.purchase.PurchaseVO">
        SELECT 
            orderCode,
            MAX(productName) AS productName,
            COUNT(*) AS totalCount,
            SUM(paidAmount) AS paidAmount,
            MAX(orderDate) AS orderDate,
            MAX(orderStatus) AS orderStatus
        FROM purchase
        WHERE userId = #{userId}
        GROUP BY orderCode
        ORDER BY orderCode DESC
    </select>
	
	<insert id="insertReview" parameterType="ReviewVO">
    	INSERT INTO review (reviewId, orderCode, productCode, userId, content, reg_date)
    	VALUES (review_seq.NEXTVAL, #{orderCode}, #{productCode}, #{userId}, #{content}, SYSDATE)
	</insert>

	<insert id="insertPurchase" parameterType="java.util.List">
    	INSERT INTO purchase (
        	orderCode, userId, productCode, productName, productWeight, crushing, orderPrice, 
        	orderCount, receiverName, receiverPhone, address, orderMemo, paymentMethod, 
        	orderStatus, isReview, 
        	receiptId, approvalId, approvalDate, paidAmount, pgStatus, cancelAmount) 
        	VALUES 
    <foreach collection="list" item="item" separator=",">
    	(#{item.orderCode}, #{item.userId}, #{item.productCode}, #{item.productName}, #{item.productWeight}, 
         #{item.crushing}, #{item.orderPrice}, #{item.orderCount}, #{item.receiverName}, #{item.receiverPhone}, 
         #{item.address}, #{item.orderMemo}, #{item.paymentMethod}, #{item.orderStatus}, #{item.isReview},
         #{item.receiptId}, #{item.approvalId}, #{item.approvalDate}, #{item.paidAmount}, #{item.pgStatus}, #{item.cancelAmount})
    </foreach>
	</insert>
	
	<!-- 결제 완료 후 영수증 정보 -->
	<update id="updatePaymentInfo" parameterType="com.eighty.purchase.PurchaseVO">
    UPDATE purchase SET receiptId = #{receiptId}, approvalId = #{approvalId}, approvalDate = #{approvalDate},
        paidAmount = #{paidAmount}, pgStatus = 'PAID', orderStatus = 'PAID' WHERE orderCode = #{orderCode}
	</update>

	<!-- 관리자페이지 전체 매출 / 주문수량 -->
	<select id="getOverallSummary" resultType="map">
    	SELECT IFNULL(SUM(paidAmount), 0) AS GROSS_SALES,  <!-- 총 매출 계산, IFNULL(..., 0) 입력값이 없을경우 0, GROSS_SALES 총 매출  -->
        
        IFNULL(SUM(CASE WHEN p.productCode != 'DELIVERY'   <!-- productCode의 DELIVERY항목 제외 -->
        THEN p.orderPrice * p.orderCount ELSE 0 END), 0) AS NET_SALES, <!--상품일경우 계산, '거짓'(배송비)값은 0으로 처리, NET_SALES 순매출액 -->
        
        COUNT(DISTINCT p.orderCode) AS TOTAL_ORDERS, <!-- orderCode중복을 제거한 전체 주문건수 -->
        
        COUNT(DISTINCT CASE WHEN p.paymentMethod = 'CARD' THEN p.orderCode END) AS CARD_CNT,
        COUNT(DISTINCT CASE WHEN p.paymentMethod = 'BANK' THEN p.orderCode END) AS BANK_CNT,
        
        CASE WHEN COUNT(DISTINCT p.orderCode) = 0 THEN 0 
        ELSE IFNULL(SUM(p.paidAmount), 0) / COUNT(DISTINCT p.orderCode) END AS ATV
		FROM purchase p WHERE p.pgStatus = 'PAID'
	</select>
	
	<select id="getProductStats" resultType="map">
    	SELECT p.product_name AS productName, IFNULL(SUM(pc.orderCount), 0) AS TOTAL_COUNT
		FROM product p LEFT OUTER JOIN purchase pc ON p.product_code = pc.productCode
		GROUP BY p.product_code, p.product_name
		ORDER BY TOTAL_COUNT DESC;
	</select>

</mapper>